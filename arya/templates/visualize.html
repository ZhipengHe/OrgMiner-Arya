{% extends 'base.html' %}
{% import "bootstrap/wtf.html" as wtf %}

{% block main %}
<div class="container-fluid">
<!-- Outer row-->
<div class="row">

<!-- Left panel: for model visualization -->
<div class="col-lg-8 col-xl-9">
    <div class="row my-3">
    <div class="col">
        <div class="row shadow-sm">
        <div class="col-4 px-0">
            <ul class="nav nav-pills small">
                <li class="nav-item">
                    <a class="nav-link bg-info text-white active">
                        Organizational model view
                    </a>
                </li>
            </ul>
        </div>
        <div class="col-8 px-0">
            <ul class="nav nav-pills small float-right">
                <li class="nav-item ml-2">
                    <a class="nav-link bg-secondary text-white reset-btn"
                        label="organizational-model">
                        Reset view
                    </a>
                </li>
                <li class="nav-item ml-2">
                    <a class="nav-link bg-secondary text-white export-btn"
                        label="organizational-model">
                        Export SVG
                    </a>
                </li>
            </ul>
        </div>
        </div>

        <div class="row">
        <div class="col mx-auto canvas border border-info rounded shadow" 
            id="canvas-org-m" label="organizational-model">
        </div>
        </div>
    </div>
    </div>

    <div class="row my-3">
    <div class="col">
        <div class="row shadow-sm">
        <div class="col-4 px-0">
            <ul class="nav nav-pills small">
                <li class="nav-item">
                    <a class="nav-link bg-info text-white active">
                        Process model view
                    </a>
                </li>
            </ul>
        </div>
        <div class="col-8 px-0">
            <ul class="nav nav-pills small float-right">
                <li class="nav-item ml-2">
                    <a class="nav-link bg-secondary text-white reset-btn"
                        label="process-model">
                        Reset view
                    </a>
                </li>
                <li class="nav-item ml-2">
                    <a class="nav-link bg-secondary text-white export-btn"
                        label="process-model">
                        Export SVG
                    </a>
                </li>
            </ul>
        </div>
        </div>

        <div id="proc-m-title"></div>
        <div class="row">
        <div class="col mx-auto canvas border border-info rounded" 
            id="canvas-proc-m" label="process-model">
        </div>
        </div>
    </div>
    </div>
</div>

<!-- Right panel: for statistics report -->
<div class="col-lg-4 col-xl-3 text-nowrap">
    <!-- Stats of global conformance -->
    <div class="row my-3">
    <div class="col">
        <ul class="nav nav-pills small">
            <li class="nav-item">
                <a class="nav-link bg-info text-white active">
                    Global Conformance
                </a>
            </li>
        </ul>

        <div class="border border-info rounded py-2 bg-light">
            <div class="card-deck mx-auto text-center">
                <div class="card border-0">
                    <div class="card-body font-weight-bold py-1 bg-light">
                        <h5 class="score-card-val">
                            {{ '{:.3f}'.format(fitness_org_model) }}
                        </h5>
                    </div>
                    <div class="card-footer small text-secondary 
                    border-0 py-0">
                        Fitness
                    </div>
                </div>
                <div class="card border-0">
                    <div class="card-body font-weight-bold py-1 bg-light">
                        <h5 class="score-card-val">
                            {{ '{:.3f}'.format(precision_org_model) }}
                        </h5>
                    </div>
                    <div class="card-footer small text-secondary 
                    border-0 py-0">
                        Precision
                    </div>
                </div>
                <div class="card border-0">
                    <div class="card-body font-weight-bold py-1 bg-light">
                        <h5 class="score-card-val">
                            {{ '{:.3f}'.format(f1_score_org_model) }}
                        </h5>
                    </div>
                    <div class="card-footer small text-secondary 
                    border-0 py-0">
                        F1-score
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <!-- Stats of local diagnostics -->
    <div class="row my-3">
    <div class="col">
        <ul class="nav nav-pills small">
            <li class="nav-item">
                <a class="nav-link bg-info text-white active">
                    Local Diagnostics
                </a>
            </li>
        </ul>

        <div class="border border-info rounded py-2 bg-light container">
            <!-- 1. Report basic statistics -->
            <div class="row mt-2">
            <div class="card mx-auto text-center border-0">
                <div class="card-body font-weight-bold py-1 bg-light"
                    id="ld-group-name">
                    <h5 class="score-card-val">-</h5>
                </div>
            </div>
            </div>

            <div class="row mt-2">
            <div class="card-deck mx-auto text-center">
                <div class="card border-0">
                    <div class="card-body font-weight-bold py-1 bg-light"
                        id="ld-group-mem-num">
                        <h5 class="score-card-val">-</h5>
                    </div>
                    <div class="card-footer small text-secondary 
                    border-0 py-0">
                        Members
                    </div>
                </div>
                <div class="card border-0">
                    <div class="card-body font-weight-bold py-1 bg-light"
                        id="ld-group-cap-num">
                        <h5 class="score-card-val">-</h5>
                    </div>
                    <div class="card-footer small text-secondary 
                    border-0 py-0">
                        Capabilities
                    </div>
                </div>
                <div class="card border-0">
                    <div class="card-body font-weight-bold py-1 bg-light"
                        id="ld-group-events-num">
                        <h5 class="score-card-val">-</h5>
                    </div>
                    <div class="card-footer small text-secondary 
                    border-0 py-0">
                        Originated<br>Events
                    </div>
                </div>
            </div>
            </div>

            <div class="row mt-3">
            <div class="row col-12 mt-2">
                <div class="col-3">
                    <div class="card-footer text-secondary text-left
                        bg-light border-0 py-0 small">
                        Case<br>Type
                    </div>
                </div>
                <div class="col-9">
                    <div class="card-body font-weight-bold text-left
                        bg-light py-0" id="ld-mode-ct">
                        <h5 class="score-card-val">-</h5>
                    </div>
                </div>
            </div>
            <div class="row col-12 mt-2">
                <div class="col-3">
                    <div class="card-footer text-secondary text-left
                        bg-light border-0 py-0 small">
                        Activity<br>Type
                    </div>
                </div>
                <div class="col-9">
                    <div class="card-body font-weight-bold text-left
                        bg-light py-0" id="ld-mode-at">
                        <h5 class="score-card-val">-</h5>
                    </div>
                </div>
            </div>
            <div class="row col-12 mt-2">
                <div class="col-3">
                    <div class="card-footer text-secondary text-right
                        bg-light border-0 py-0 small">
                        Time<br>Type
                    </div>
                </div>
                <div class="col-9">
                    <div class="card-body font-weight-bold text-left
                        bg-light py-0" id="ld-mode-tt">
                        <h5 class="score-card-val">-</h5>
                    </div>
                </div>
            </div>
            </div>

            <div class="row mt-3">
            <div class="card-deck mx-auto text-center">
                <div class="card border-0">
                    <div class="card-body font-weight-bold py-1 bg-light"
                        id="ld-mode-events-num">
                        <h5 class="score-card-val">0</h5>
                    </div>
                    <div class="card-footer small text-secondary 
                    border-0 py-0">
                        Executions<br>(total)
                    </div>
                </div>
                <div class="card border-0">
                    <div class="card-body font-weight-bold py-1 bg-light"
                        id="ld-mode-group-events-num">
                        <h5 class="score-card-val">0</h5>
                    </div>
                    <div class="card-footer small text-secondary 
                    border-0 py-0">
                        Executions<br>(this group)
                    </div>
                </div>
                <div class="card border-0">
                    <div class="card-body font-weight-bold py-1 bg-light"
                        id="ld-mode-group-num">
                        <h5 class="score-card-val">0</h5>
                    </div>
                    <div class="card-footer small text-secondary 
                    border-0 py-0">
                        Groups<br>(capable)
                    </div>
                </div>
            </div>
            </div>

            <!-- This is a cutting line -->
            <div class="row col-12 border-bottom mt-3 mx-0"></div>

            <!-- 2. Report local diagnostic measures -->
            <div class="row mt-3">
            <div class="card-deck mx-auto text-center">
                <div class="card border-0">
                    <div class="card-body font-weight-bold py-1 bg-light"
                        id="ld-relative-focus">
                        <h5 class="score-card-val">9.999</h5>
                    </div>
                    <div class="card-footer small text-secondary 
                    border-0 py-0">
                        Relative<br>focus
                    </div>
                </div>
                <div class="card border-0">
                    <div class="card-body font-weight-bold py-1 bg-light"
                        id="ld-relative-stake">
                        <h5 class="score-card-val">9.999</h5>
                    </div>
                    <div class="card-footer small text-secondary 
                    border-0 py-0">
                        Relative<br>Stake
                    </div>
                </div>
                <div class="card border-0">
                    <div class="card-body font-weight-bold py-1 bg-light"
                        id="ld-coverage">
                        <h5 class="score-card-val">9.999</h5>
                    </div>
                    <div class="card-footer small text-secondary 
                    border-0 py-0">
                        Coverage
                    </div>
                </div>
            </div>
            </div>

            <div class="row mt-3">
                <div class="col-12 mx-auto card-footer 
                    small text-secondary text-center border-0 bg-light">
                    Member Contribution
                </div>
                <div class="col-12 mx-auto border border-warning" 
                    id="canvas-ld-memcontr">
                    (This is a canvas for plotting the bar chart)
                </div>
            </div>

        </div>
    </div>
    </div>

</div>

<!-- End of outer row -->
</div>
<!-- End of container -->
</div>
{% endblock %}

{% block javascript %}
<script src="{{url_for('static', filename='js/d3.v4.min.js')}}"></script>
<script src="{{url_for('static', filename='js/viz.js')}}"></script>
<script src="{{url_for('static', filename='js/d3-graphviz.js')}}"></script>
<script src="{{url_for('static', filename='js/d3-save-svg.min.js')}}"></script>

<script src="{{url_for('static', filename='js/arya-data.js')}}"></script>
<script src="{{url_for('static', filename='js/arya-controller.js')}}"></script>

<script>

    // retrieve organizational model data
    var orgModelData = {{ data_org_model|tojson }};

    const delim = new String({{ DELIM }});

    var df = new DataFactory(orgModelData);
    var sc = new ScoreCard(df);
    var waiter = new Waiter(df, sc);

    function renderOrgM(nodeList, edgeList) {
        var dotSrcString = df.compileDotString(nodeList, edgeList);
        //console.log("Renderer invoked for source:\n" + dotSrcString);

        var transition_effect = d3.transition()
            .duration(500).ease(d3.easeLinear);

        d3.select("#canvas-org-m").graphviz().fit(true)
            .transition(transition_effect)
            .engine("dot")
            .renderDot(dotSrcString, function() {
                waiter.attachSVGListeners(
                    [nodeList, edgeList],
                    d3.select("#canvas-org-m").select(".graph"));

                d3.select("div#canvas-org-m > svg").on("dblclick.zoom", null);
            });
    }

    function renderProcMDot(dotSrcString, title) {
        d3.select("div#proc-m-title").text(title);
        if (dotSrcString == null) {
            d3.select("#canvas-proc-m").selectAll("svg > *").remove();
        } else {
            console.log("Renderer invoked for process model.");
            var transition_effect = d3.transition()
                .duration(500).ease(d3.easeLinear);
            
            d3.select("#canvas-proc-m").graphviz().fit(true)
                .transition(transition_effect)
                .engine("dot")
                .renderDot(dotSrcString, function() {
                    d3.select("div#canvas-proc-m > svg").on(
                        "dblclick.zoom", null);
                });
        }
    }

    /* Display all group nodes and all first level modes when page loaded. */
    var [initNodeList, initEdgeList] = waiter.resetToInit();
    renderOrgM(initNodeList, initEdgeList);

    /* TODO: Setup for reset svg zoom. */
    $(".reset-btn").click(function() {
        // do nothing
        var label = $(this).attr("label");
        alert("TODO: refresh the view of " + label);
    });


    /* Setup for svg export. */
    $(".export-btn").click(function() {
        var label = $(this).attr("label");
        d3_save_svg.save(
            d3.select(".canvas[label='" + label + "']")
                .select("svg").node(), 
            {filename: label});
    });


</script>
{% endblock %}
